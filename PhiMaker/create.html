<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Project - PhiMaker</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" type="text/css" href="scrollbar.css">
</head>

<body>
    <!-- 页面标题 -->
    <h2>新建铺面</h2>

    <!-- 表单外壳（用于布局） -->
    <div class="create">
        <!-- 新建项目表单：用户在此填写铺面信息 -->
        <form id="create-project-form">
            <!-- 链接到项目名输入框 -->
            <label for="project-name">铺面名称:</label>
            <input type="text" id="project-name" name="project-name" required placeholder="例如：MyMap" aria-label="铺面名称">

            <!-- 难度：显示为数字输入框 + 滑条（互相同步） -->
            <label for="project-difficulty-number">难度 (数值):</label>
            <div class="number-range-row">
                <!-- 数字框（可直接输入精确数值） -->
                <input type="number" step="0.1" id="project-difficulty-number" name="project-difficulty" min="0"
                    max="20" value="8" title="请输入铺面难度（数字，0-20）" placeholder="0-20" aria-label="铺面难度数字">
                <!-- 滑条：用于快速调整难度 -->
                <input type="range" step="0.1" id="project-difficulty-range" min="0" max="20" value="8"
                    aria-label="铺面难度滑条">
            </div>

            <!-- 难度等级（文本） -->
            <label for="project-diffculty-level">难度等级:</label>
            <input type="text" id="project-diffculty-level" name="project-difficulty-level" required
                title="请输入铺面难度等级（如 Easy / Normal / Hard 等）" placeholder="就是铺子右下角那个" aria-label="铺面难度等级">

            <!-- 作者信息（文本输入） -->
            <label for="project-author">作者:</label>
            <input type="text" id="project-author" value="UK" title="默认为 'UK'" name="project-author"
                placeholder="你自己, 默认为 'UK'" required aria-label="作者">

            <!-- 音乐作者 -->
            <label for="project-music-author">音乐作者:</label>
            <input type="text" id="project-music-author" value="UK" title="默认为 'UK'" name="project-music-author"
                placeholder="音乐作者, 默认为 'UK'" required aria-label="音乐作者">

            <!-- 插图作者 -->
            <label for="project-picture-author">插图作者:</label>
            <input type="text" id="project-picture-author" value="UK" title="默认为 'UK'" name="project-picture-author"
                placeholder="插图作者, 默认为 'UK'" aria-label="插图作者" required>

            <!-- tip 文本 -->
            <label for="project-tip">Tip:</label>
            <input type="text" id="project-tip" value='' placeholder="Tip: 不写的话会给你塞一条别的" name="project-tip" required
                aria-label="提示">

            <!-- 提交按钮：右对齐（由 CSS 控制） -->
            <button type="submit" id="create-submit">Create Project</button>
        </form>

        <!-- 右侧上传面板（音乐与图片） -->
        <aside class="side-panel" aria-label="上传素材">
            <h3>上传素材</h3>
            <div class="file-input-row">
                <div  class="file-in">
                    <label for="map-music">铺面音乐（必选，mp3/ogg/wav）</label>
                    <p>tip:mp3格式可能会带来不可预见的延迟，wav的文件占用空间较大，可能会导致上传失败，<im>推荐使用ogg格式</im>
                    </p>
                    <input type="file" id="map-music" name="map-music" accept=".ogg,.wav,.mp3,audio/ogg,audio/wav,audio/mpeg" class="upload" required>
                    <div class="file-meta">
                        <span class="file-name" id="map-music-name">选择音乐文件</span>
                        <button type="button" class="clear-btn" data-target="map-music" aria-label="清除音乐选择">×</button>
                    </div>
                    <div class="file-preview" id="map-music-preview" aria-hidden="true"></div>
                </div>
                <div class="file-in">
                    <label for="map-image">铺面图片（必选，png/jpg）</label>

                    <input type="file" id="map-image" name="map-image" accept="image/*" class="upload" required>
                    <div class="file-meta">
                        <span class="file-name" id="map-image-name">选择图片文件</span>
                        <button type="button" class="clear-btn" data-target="map-image" aria-label="清除图片选择">×</button>
                    </div>
                    <div class="file-preview" id="map-image-preview" aria-hidden="true"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- 页面脚本：同步滑条与数字，并处理表单提交 -->
    <script>
        // 表单提交：读取文本字段与可选的文件（图片/音频），通过 postMessage 发送给父窗口
        document.getElementById('create-project-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const formEl = document.getElementById('create-project-form');
            // 当 JS 拦截提交时，手动触发表单验证提示
            if (formEl && !formEl.checkValidity()) {
                formEl.reportValidity();
                return;
            }

            // 注意：页面布局中 file inputs 放在表单外（aside），因此它们不会被 form.checkValidity() 检测到。
            // 在这里显式校验文件输入并触发原生提示（reportValidity）以告知用户。
            const musicInp = document.getElementById('map-music');
            const imageInp = document.getElementById('map-image');
            if (musicInp && (!musicInp.files || musicInp.files.length === 0)) {
                // 调用原生提示（如果浏览器支持）
                if (typeof musicInp.reportValidity === 'function') {
                    musicInp.reportValidity();
                } else {
                    alert('请上传音乐文件（必填）');
                }
                return;
            }
            if (imageInp && (!imageInp.files || imageInp.files.length === 0)) {
                if (typeof imageInp.reportValidity === 'function') {
                    imageInp.reportValidity();
                } else {
                    alert('请上传铺面图片（必填）');
                }
                return;
            }

            const getVal = id => document.getElementById(id) ? document.getElementById(id).value : '';
            const payload = {
                name: getVal('project-name'),
                difficulty: parseFloat(getVal('project-difficulty-number')) || 0,
                difficultyLevel: getVal('project-diffculty-level'),
                author: getVal('project-author'),
                musicAuthor: getVal('project-music-author'),
                pictureAuthor: getVal('project-picture-author'),
                tip: getVal('project-tip'),
                files: {}
            };

            // helper: 读取 file input 为 dataURL（如果有文件）
            function readFileData(fileInputId) {
                return new Promise((resolve) => {
                    const inp = document.getElementById(fileInputId);
                    if (!inp || !inp.files || inp.files.length === 0) return resolve(null);
                    const file = inp.files[0];
                    const reader = new FileReader();
                    reader.onload = function (e) { resolve({ name: file.name, type: file.type, dataURL: e.target.result }); };
                    reader.onerror = function () { resolve(null); };
                    reader.readAsDataURL(file);
                });
            }

            Promise.all([readFileData('map-music'), readFileData('map-image')]).then(([music, image]) => {
                if (music) payload.files.music = music;
                if (image) payload.files.image = image;

                // 发送消息给父窗口（父页面负责校验 origin/权限）
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'create-project', payload }, '*');
                    // 可视反馈：替代 alert
                    const status = document.createElement('div');
                    status.textContent = '已发送新建请求';
                    status.style.color = '#bfcfff';
                    document.body.appendChild(status);
                } else {
                    alert('无法找到父窗口，新的项目数据:\n' + JSON.stringify(payload, null, 2));
                }
            });
        });

        // 同步逻辑：数字输入与滑条互相同步（支持浮点 step）
        (function () {
            const numInput = document.getElementById('project-difficulty-number');
            const rangeInput = document.getElementById('project-difficulty-range');
            if (!numInput || !rangeInput) return;

            // helper: clamp
            function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

            // 滑条变化 -> 更新数字框
            rangeInput.addEventListener('input', function (e) {
                // 保持小数位（依据 step）
                const step = parseFloat(rangeInput.step) || 1;
                const v = parseFloat(e.target.value);
                numInput.value = (Math.round(v / step) * step).toFixed((step.toString().split('.')[1] || '').length);
            });

            // 数字框变化 -> 更新滑条（并约束在范围内）
            numInput.addEventListener('input', function (e) {
                let v = parseFloat(e.target.value);
                if (isNaN(v)) v = 0;
                const min = parseFloat(rangeInput.min) || 0;
                const max = parseFloat(rangeInput.max) || 100;
                const step = parseFloat(rangeInput.step) || 1;
                v = clamp(v, min, max);
                // 规范小数位
                const decimals = (step.toString().split('.')[1] || '').length;
                rangeInput.value = v;
                e.target.value = v.toFixed(decimals);
            });
        })();

        // 显示已选文件名与大小
        (function () {
            function niceSize(bytes) {
                if (!bytes && bytes !== 0) return '';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }

            function attachFilePreview(inputId, nameId, placeholder, previewId) {
                const inp = document.getElementById(inputId);
                const label = document.getElementById(nameId);
                const preview = document.getElementById(previewId);
                if (!inp || !label) return;
                // 初始化占位文本
                if (!label.textContent || label.textContent.trim() === '') label.textContent = placeholder || '';

                // 找到同级的清除按钮（如果存在）
                const clearBtn = label.parentElement ? label.parentElement.querySelector('.clear-btn') : null;

                function clearSelection() {
                    // 清除 input
                    try { inp.value = ''; } catch (e) { /* ignore */ }
                    // 恢复占位文本
                    if (label) { label.textContent = placeholder || '未选择文件'; label.title = ''; }
                    // 清除预览并撤销 objectURL
                    if (preview) {
                        if (preview._objURL) {
                            URL.revokeObjectURL(preview._objURL);
                            preview._objURL = null;
                        }
                        preview.innerHTML = '';
                        preview.setAttribute('aria-hidden', 'true');
                    }
                }

                if (clearBtn) {
                    clearBtn.addEventListener('click', function () {
                        clearSelection();
                    });
                }

                inp.addEventListener('change', function () {
                    if (inp.files && inp.files.length > 0) {
                        const f = inp.files[0];
                        label.textContent = f.name + ' (' + niceSize(f.size) + ')';
                        label.title = f.name;

                        // 生成预览
                        if (preview) {
                            // 清理旧预览
                            if (preview._objURL) { URL.revokeObjectURL(preview._objURL); preview._objURL = null; }
                            preview.innerHTML = '';
                            // 图片缩略
                            if (f.type && f.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.className = 'file-thumb';
                                const obj = URL.createObjectURL(f);
                                preview._objURL = obj;
                                img.src = obj;
                                img.alt = f.name;
                                preview.appendChild(img);
                                preview.setAttribute('aria-hidden', 'false');
                            } else if (f.type && f.type.startsWith('audio/')) {
                                const audio = document.createElement('audio');
                                audio.className = 'audio-preview';
                                audio.controls = true;
                                const obj = URL.createObjectURL(f);
                                preview._objURL = obj;
                                audio.src = obj;
                                preview.appendChild(audio);
                                preview.setAttribute('aria-hidden', 'false');
                            } else {
                                preview.setAttribute('aria-hidden', 'true');
                            }
                        }
                    } else {
                        // 无文件，恢复占位
                        if (label) { label.textContent = placeholder || '未选择文件'; label.title = ''; }
                        if (preview) { if (preview._objURL) { URL.revokeObjectURL(preview._objURL); preview._objURL = null; } preview.innerHTML = ''; preview.setAttribute('aria-hidden', 'true'); }
                    }
                });
            }

            attachFilePreview('map-music', 'map-music-name', '选择音乐文件', 'map-music-preview');
            attachFilePreview('map-image', 'map-image-name', '选择图片文件', 'map-image-preview');
        })();
    </script>
</body>

</html>