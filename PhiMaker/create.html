<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Project - PhiMaker</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 自定义滚动条样式：iframe 内页面使用（跨浏览器规则） */
        /* Firefox 支持 */
        html, body, div, textarea, pre {
            scrollbar-width: thin; /* auto | thin | none */
            scrollbar-color: #7a4cff rgba(255,255,255,0.02);
        }
        /* Webkit 浏览器（Chrome/Edge/Safari） */
        html::-webkit-scrollbar, body::-webkit-scrollbar, div::-webkit-scrollbar, textarea::-webkit-scrollbar, pre::-webkit-scrollbar { width: 10px; height: 10px; }
        html::-webkit-scrollbar-track, body::-webkit-scrollbar-track, div::-webkit-scrollbar-track, textarea::-webkit-scrollbar-track, pre::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 8px; }
        html::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb, div::-webkit-scrollbar-thumb, textarea::-webkit-scrollbar-thumb, pre::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #7a4cff, #5b3bff); border-radius: 8px; box-shadow: inset 0 0 4px rgba(0,0,0,0.3); }
        /* 备用：确保颜色属性也设置在 body 上以兼容部分浏览器 */
        body { scrollbar-color: #7a4cff rgba(255,255,255,0.02); }
        /* 让表单与右侧上传栏并列 */
        .create { display: flex; gap: 18px; align-items: flex-start; }
        .create form { flex: 1 1 auto; }
        .create .side-panel { flex: 0 0 260px; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03); }
        .file-input-row { display:flex; flex-direction:column; gap:10px; }
        .file-input-row label { font-size:14px; }
        /* 为 range 增强可见度：更粗轨道、更大拇指 */
        .number-range-row input[type=range] { height: 10px; }
        .number-range-row input[type=range]::-webkit-slider-thumb { width: 22px; height: 22px; }
        .number-range-row input[type=range]::-moz-range-thumb { width: 22px; height: 22px; }
    </style>
</head>

<body>
    <!-- 页面标题 -->
    <h2>新建铺面</h2>

    <!-- 表单外壳（用于布局） -->
    <div class="create">
        <!-- 新建项目表单：用户在此填写铺面信息 -->
        <form id="create-project-form">
            <!-- 链接到项目名输入框 -->
            <label for="project-name">铺面名称:</label>
            <input type="text" id="project-name" name="project-name" required placeholder="例如：MyMap" aria-label="铺面名称">

            <!-- 难度：显示为数字输入框 + 滑条（互相同步） -->
            <label for="project-difficulty-number">难度 (数值):</label>
            <div class="number-range-row">
                <!-- 数字框（可直接输入精确数值） -->
                <input type="number" step="0.1" id="project-difficulty-number" name="project-difficulty" min="0" max="20" value="8"
                    title="请输入铺面难度（数字，0-20）" placeholder="0-20" aria-label="铺面难度数字">
                <!-- 滑条：用于快速调整难度 -->
                <input type="range" step="0.1" id="project-difficulty-range" min="0" max="20" value="8" aria-label="铺面难度滑条">
            </div>

            <!-- 难度等级（文本） -->
            <label for="project-diffculty-level">难度等级:</label>
            <input type="text" id="project-diffculty-level" name="project-difficulty-level" required
                title="请输入铺面难度等级（如 Easy / Normal / Hard 等）" placeholder="例如：Hard" aria-label="铺面难度等级">

            <!-- 作者信息（文本输入） -->
            <label for="project-author">作者:</label>
            <input type="text" id="project-author" title="默认为 'UK'" name="project-author" placeholder="你自己, 默认为 'UK'" required aria-label="作者">

            <!-- 音乐作者 -->
            <label for="project-music-author">音乐作者:</label>
            <input type="text" id="project-music-author" title="默认为 'UK'" name="project-music-author" placeholder="音乐作者, 默认为 'UK'" required aria-label="音乐作者">

            <!-- 插图作者 -->
            <label for="project-picture-author">插图作者:</label>
            <input type="text" id="project-picture-author" title="默认为 'UK'" name="project-picture-author" placeholder="插图作者, 默认为 'UK'" aria-label="插图作者" required>

            <!-- tip 文本 -->
            <label for="project-tip">Tip:</label>
            <input type="text" id="project-tip" placeholder="Tip: 不写的话会给你塞一条别的" name="project-tip" required aria-label="提示">

            <!-- 提交按钮：右对齐（由 CSS 控制） -->
            <button type="submit" id="create-submit">Create Project</button>
        </form>
        
        <!-- 右侧上传面板（音乐与图片） -->
        <aside class="side-panel" aria-label="上传素材">
            <h3>上传素材</h3>
            <div class="file-input-row">
                <div>
                    <label for="map-music">铺面音乐（必选，mp3/ogg）</label>
                    <input type="file" id="map-music" name="map-music" accept="audio/*">
                </div>
                <div>
                    <label for="map-image">铺面图片（必选，png/jpg）</label>
                    <input type="file" id="map-image" name="map-image" accept="image/*">
                </div>
            </div>
        </aside>
    </div>
    
    <!-- 页面脚本：同步滑条与数字，并处理表单提交 -->
    <script>
        // 表单提交：读取文本字段与可选的文件（图片/音频），通过 postMessage 发送给父窗口
        document.getElementById('create-project-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const getVal = id => document.getElementById(id) ? document.getElementById(id).value : '';
            const payload = {
                name: getVal('project-name'),
                difficulty: parseFloat(getVal('project-difficulty-number')) || 0,
                difficultyLevel: getVal('project-diffculty-level'),
                author: getVal('project-author'),
                musicAuthor: getVal('project-music-author'),
                pictureAuthor: getVal('project-picture-author'),
                tip: getVal('project-tip'),
                files: {}
            };

            // helper: 读取 file input 为 dataURL（如果有文件）
            function readFileData(fileInputId) {
                return new Promise((resolve) => {
                    const inp = document.getElementById(fileInputId);
                    if (!inp || !inp.files || inp.files.length === 0) return resolve(null);
                    const file = inp.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) { resolve({ name: file.name, type: file.type, dataURL: e.target.result }); };
                    reader.onerror = function() { resolve(null); };
                    reader.readAsDataURL(file);
                });
            }

            Promise.all([readFileData('map-music'), readFileData('map-image')]).then(([music, image]) => {
                if (music) payload.files.music = music;
                if (image) payload.files.image = image;

                // 发送消息给父窗口（父页面负责校验 origin/权限）
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'create-project', payload }, '*');
                    // 可视反馈：替代 alert
                    const status = document.createElement('div');
                    status.textContent = '已发送新建请求';
                    status.style.color = '#bfcfff';
                    document.body.appendChild(status);
                } else {
                    alert('无法找到父窗口，新的项目数据:\n' + JSON.stringify(payload, null, 2));
                }
            });
        });

        // 同步逻辑：数字输入与滑条互相同步（支持浮点 step）
        (function(){
            const numInput = document.getElementById('project-difficulty-number');
            const rangeInput = document.getElementById('project-difficulty-range');
            if (!numInput || !rangeInput) return;

            // helper: clamp
            function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

            // 滑条变化 -> 更新数字框
            rangeInput.addEventListener('input', function(e){
                // 保持小数位（依据 step）
                const step = parseFloat(rangeInput.step) || 1;
                const v = parseFloat(e.target.value);
                numInput.value = (Math.round(v / step) * step).toFixed((step.toString().split('.')[1] || '').length);
            });

            // 数字框变化 -> 更新滑条（并约束在范围内）
            numInput.addEventListener('input', function(e){
                let v = parseFloat(e.target.value);
                if (isNaN(v)) v = 0;
                const min = parseFloat(rangeInput.min) || 0;
                const max = parseFloat(rangeInput.max) || 100;
                const step = parseFloat(rangeInput.step) || 1;
                v = clamp(v, min, max);
                // 规范小数位
                const decimals = (step.toString().split('.')[1] || '').length;
                rangeInput.value = v;
                e.target.value = v.toFixed(decimals);
            });
        })();
    </script>
</body>

</html>